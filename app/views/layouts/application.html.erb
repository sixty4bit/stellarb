<!DOCTYPE html>
<html>
  <head>
    <title><%= content_for(:title) || "StellArb" %></title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= yield :head %>

    <link rel="icon" href="/icon.png" type="image/png">
    <link rel="icon" href="/icon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="/icon.png">

    <%= stylesheet_link_tag :app, "data-turbo-track": "reload" %>
    <%= javascript_importmap_tags %>

    <style>
      /* Terminal-style monospace font */
      body {
        font-family: 'Courier New', Courier, monospace;
      }
    </style>
  </head>

  <body class="bg-blue-950 text-white"<%= " data-sound-enabled=\"#{current_user.sound_enabled?}\"".html_safe if current_user %>>
    <% if current_user %>
      <% if defined?(ActionCable) %>
      <!-- Turbo Stream subscriptions for real-time updates -->
      <%= turbo_stream_from "inbox_unread_badge_user_#{current_user.id}" %>
      <%= turbo_stream_from "ships_user_#{current_user.id}" %>
      <%= turbo_stream_from "buildings_user_#{current_user.id}" %>
      <% end %>

      <!-- Main Game Layout -->
      <div class="flex h-screen overflow-hidden" data-controller="keyboard-navigation">
        <!-- Left Menu -->
        <%= render 'shared/navigation_menu' %>

        <!-- Right Content Panel -->
        <main class="flex-1 overflow-y-auto">
          <turbo-frame id="content_panel" class="block p-6">
            <%= yield %>
          </turbo-frame>
        </main>
      </div>

      <!-- Keyboard shortcuts help (hidden by default) -->
      <div id="keyboard-help" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-blue-900 border-2 border-orange-500 p-6 max-w-md">
          <h2 class="text-orange-500 font-bold mb-4">Keyboard Shortcuts</h2>
          <dl class="space-y-2 text-sm">
            <div class="flex">
              <dt class="w-20 text-lime-400">j/k</dt>
              <dd>Navigate up/down</dd>
            </div>
            <div class="flex">
              <dt class="w-20 text-lime-400">Enter</dt>
              <dd>Select</dd>
            </div>
            <div class="flex">
              <dt class="w-20 text-lime-400">Esc/q</dt>
              <dd>Go back</dd>
            </div>
            <div class="flex">
              <dt class="w-20 text-lime-400">H</dt>
              <dd>Home (Inbox)</dd>
            </div>
            <div class="flex">
              <dt class="w-20 text-lime-400">?</dt>
              <dd>Show this help</dd>
            </div>
          </dl>
          <button class="mt-4 text-orange-500" onclick="document.getElementById('keyboard-help').classList.add('hidden')">
            Press any key to close
          </button>
        </div>
      </div>

      <!-- Onboarding Tutorial Overlay -->
      <% if current_user.needs_onboarding? %>
        <%= render 'shared/onboarding_overlay', user: current_user %>
      <% end %>
    <% else %>
      <!-- Login layout -->
      <main class="container mx-auto mt-28 px-5 max-w-md">
        <%= yield %>
      </main>
    <% end %>

    <!-- Flash messages -->
    <% if flash.any? %>
      <div class="fixed top-4 right-4 space-y-2 z-50">
        <% flash.each do |type, msg| %>
          <div class="bg-<%= type == 'notice' ? 'green' : 'red' %>-800 border border-<%= type == 'notice' ? 'green' : 'red' %>-600 text-white px-4 py-2 rounded shadow-lg">
            <%= msg %>
          </div>
        <% end %>
      </div>
    <% end %>

    <!-- Sound effects container (populated via Turbo Streams) -->
    <div id="sounds" class="hidden"></div>
  </body>
</html>