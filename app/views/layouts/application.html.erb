<!DOCTYPE html>
<html>
  <head>
    <title><%= content_for(:title) || "StellArb" %></title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= yield :head %>

    <link rel="icon" href="/icon.png" type="image/png">
    <link rel="icon" href="/icon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="/icon.png">

    <%= stylesheet_link_tag :app, "data-turbo-track": "reload" %>
    <%= javascript_importmap_tags %>

    <style>
      /* Terminal-style monospace font */
      body {
        font-family: 'Courier New', Courier, monospace;
      }
    </style>
  </head>

  <body class="bg-blue-950 text-white"<%= " data-sound-enabled=\"#{current_user.sound_enabled?}\"".html_safe if current_user %>>
    <% if current_user %>
      <% if defined?(ActionCable) %>
      <!-- Turbo Stream subscriptions for real-time updates -->
      <%= turbo_stream_from "inbox_unread_badge_user_#{current_user.id}" %>
      <%= turbo_stream_from "user_#{current_user.id}_notifications" %>
      <%= turbo_stream_from "ships_user_#{current_user.id}" %>
      <%= turbo_stream_from "buildings_user_#{current_user.id}" %>
      <% end %>

      <!-- Main Game Layout -->
      <div class="flex flex-col h-screen overflow-hidden" data-controller="mobile-menu keyboard-navigation">
        <!-- Mobile Top Bar (visible only on mobile) -->
        <div class="mobile-top-bar flex md:hidden items-center justify-between bg-blue-900 border-b-2 border-orange-500 px-4 py-2 sticky top-0 z-40">
          <button data-action="click->mobile-menu#toggle" class="text-orange-500 p-1" aria-label="Open menu">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
            </svg>
          </button>
          <div class="flex items-center gap-3 text-sm">
            <span class="text-orange-500 font-bold"><%= current_user.name %></span>
            <span class="text-lime-400">Credits: <%= number_with_delimiter(current_user.credits.to_i) %></span>
            <span id="mobile_inbox_unread_badge"><%= unread_badge(current_user) %></span>
          </div>
        </div>

        <!-- Mobile Drawer Backdrop -->
        <div data-mobile-menu-target="backdrop" data-action="click->mobile-menu#close" class="hidden fixed inset-0 bg-black bg-opacity-50 z-40 md:hidden"></div>

        <!-- Mobile Drawer -->
        <div data-mobile-menu-target="drawer" data-action="click->mobile-menu#closeOnNav" class="fixed inset-y-0 left-0 z-50 w-64 transform -translate-x-full transition-transform duration-200 ease-in-out md:hidden">
          <%= render 'shared/navigation_menu' %>
        </div>

        <div class="flex flex-1 overflow-hidden">
          <!-- Left Menu (desktop only) -->
          <div class="hidden md:block">
            <%= render 'shared/navigation_menu' %>
          </div>

          <!-- Right Content Panel -->
          <main class="flex-1 overflow-y-auto">
            <turbo-frame id="content_panel" class="block p-6">
              <%= yield %>
            </turbo-frame>
          </main>
        </div>
      </div>

      <!-- Keyboard shortcuts help (hidden by default) -->
      <div id="keyboard-help" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-blue-900 border-2 border-orange-500 p-6 max-w-md">
          <h2 class="text-orange-500 font-bold mb-4">Keyboard Shortcuts</h2>
          <dl class="space-y-2 text-sm">
            <div class="flex">
              <dt class="w-20 text-lime-400">Tab</dt>
              <dd>Switch menu/content</dd>
            </div>
            <div class="flex">
              <dt class="w-20 text-lime-400">j/k</dt>
              <dd>Navigate up/down</dd>
            </div>
            <div class="flex">
              <dt class="w-20 text-lime-400">Enter</dt>
              <dd>Select</dd>
            </div>
            <div class="flex">
              <dt class="w-20 text-lime-400">Esc/q</dt>
              <dd>Go back</dd>
            </div>
            <div class="flex">
              <dt class="w-20 text-lime-400">H</dt>
              <dd>Home (Inbox)</dd>
            </div>
            <div class="flex">
              <dt class="w-20 text-lime-400">?</dt>
              <dd>Show this help</dd>
            </div>
          </dl>
          <button class="mt-4 text-orange-500" onclick="document.getElementById('keyboard-help').classList.add('hidden')">
            Press any key to close
          </button>
        </div>
      </div>

      <!-- Persistent Explore Button -->
      <% if current_user.ships.operational.any? && controller_name != 'exploration' %>
        <%= button_to growing_arcs_exploration_path, class: "fixed top-4 right-4 z-40 bg-purple-700 hover:bg-purple-600 text-white rounded-full px-4 py-2 shadow-lg flex items-center" do %>
          ðŸ”­<span class="hidden sm:inline ml-1">Explore</span>
        <% end %>
      <% end %>

      <!-- Onboarding Tutorial Overlay -->
      <% if current_user.needs_onboarding? %>
        <%= render 'shared/onboarding_overlay', user: current_user %>
      <% end %>
    <% else %>
      <!-- Login layout -->
      <main class="container mx-auto mt-28 px-5 max-w-md">
        <%= yield %>
      </main>
    <% end %>

    <!-- Flash messages -->
    <% if flash.any? %>
      <div class="fixed top-4 right-4 space-y-2 z-50">
        <% flash.each do |type, msg| %>
          <div class="bg-<%= type == 'notice' ? 'green' : 'red' %>-800 border border-<%= type == 'notice' ? 'green' : 'red' %>-600 text-white px-4 py-2 rounded shadow-lg">
            <%= msg %>
          </div>
        <% end %>
      </div>
    <% end %>

    <!-- Sound effects container (populated via Turbo Streams) -->
    <div id="sounds" class="hidden"></div>
  </body>
</html>