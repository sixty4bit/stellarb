<turbo-frame id="content_panel">
<%= render 'shared/breadcrumbs', breadcrumbs: @breadcrumbs %>

<div class="max-w-6xl">
  <h1 class="text-2xl font-bold mb-1 text-orange-500">Buildings</h1>
  <div class="text-sm text-gray-400 mb-6">Your constructed facilities</div>

  <!-- Build New Building Button -->
  <div class="mb-6">
    <%= link_to new_building_path,
        class: "inline-block px-6 py-3 bg-orange-800 hover:bg-orange-700 border border-orange-600 text-white font-bold transition-colors",
        data: { turbo_frame: "content_panel" } do %>
      + Construct New Building
    <% end %>
  </div>

  <!-- Filters -->
  <div class="flex gap-4 mb-6 flex-wrap">
    <%= link_to buildings_path,
        class: "px-3 py-1 text-sm #{params[:type].blank? ? 'bg-orange-800 text-white' : 'bg-blue-800 text-gray-300'} rounded transition-colors",
        data: { turbo_frame: "content_panel" } do %>
      All
    <% end %>
    <% Building::FUNCTIONS.each do |fn| %>
      <%= link_to buildings_path(type: fn),
          class: "px-3 py-1 text-sm #{params[:type] == fn ? 'bg-orange-800 text-white' : 'bg-blue-800 text-gray-300'} rounded transition-colors",
          data: { turbo_frame: "content_panel" } do %>
        <%= fn.humanize %>
      <% end %>
    <% end %>
  </div>

  <% if @buildings.any? %>
    <div class="space-y-2">
      <% @buildings.each do |building| %>
        <%= link_to building_path(building),
            class: "block bg-blue-900 border border-blue-700 p-4 hover:border-orange-500 transition-colors #{building.disabled? ? 'opacity-60' : ''}",
            data: { turbo_frame: "content_panel", keyboard_navigation_target: "contentItem", action: "mouseenter->keyboard-navigation#selectContentItem" } do %>
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <span class="text-xs font-mono text-gray-500"><%= building.short_id %></span>
              <span class="font-bold text-white"><%= building.name %></span>
              <span class="text-xs bg-blue-800 text-gray-300 px-2 py-0.5 rounded">
                T<%= building.tier %>
              </span>
              <% if building.disabled? %>
                <span class="text-xs bg-red-900 text-red-400 px-2 py-0.5 rounded">
                  DISABLED
                </span>
              <% elsif building.status == 'under_construction' %>
                <span class="text-xs text-orange-400">
                  [UNDER CONSTRUCTION]
                </span>
                <% if building.construction_ends_at %>
                  <span class="text-xs text-yellow-400 ml-1"
                        data-controller="countdown"
                        data-countdown-arrival-value="<%= building.construction_ends_at.iso8601 %>"
                        data-countdown-frame-value="content_panel"
                        data-countdown-refresh-value="true">
                    (<%= distance_of_time_in_words(Time.current, building.construction_ends_at) %>)
                  </span>
                <% end %>
              <% elsif building.status != 'active' %>
                <span class="text-xs text-orange-400">
                  [<%= building.status.upcase.tr('_', ' ') %>]
                </span>
              <% else %>
                <span class="text-xs text-lime-400">
                  [ACTIVE]
                </span>
              <% end %>
            </div>
            <div class="text-sm">
              <span class="text-gray-400"><%= building.function.humanize %></span>
            </div>
          </div>
          <div class="text-sm text-gray-400 mt-2 flex flex-wrap gap-x-4">
            <span>
              <span class="text-gray-500">System:</span>
              <%= building.system.name %>
            </span>
            <span>
              <span class="text-gray-500">Race:</span>
              <%= building.race.humanize %>
            </span>
            <% if building.staff.any? %>
              <span class="text-lime-400">
                <span class="text-gray-500">Staff:</span>
                <%= building.staff.count %>/<%= building.building_attributes&.dig('staff_slots', 'max') || '?' %>
              </span>
            <% end %>
            <% if building.building_attributes&.dig('output_rate') %>
              <span>
                <span class="text-gray-500">Output:</span>
                <%= building.building_attributes['output_rate'].to_i %>/hr
              </span>
            <% end %>
          </div>
        <% end %>
      <% end %>
    </div>

    <!-- Summary -->
    <div class="mt-6 p-4 bg-blue-950 border border-blue-800 text-sm text-gray-400">
      <span class="text-white font-semibold"><%= @buildings.count %></span> buildings
      <% operational = @buildings.select(&:operational?).count %>
      <% if operational < @buildings.count %>
        • <span class="text-lime-400"><%= operational %></span> operational
        • <span class="text-orange-400"><%= @buildings.count - operational %></span> offline
      <% end %>
    </div>
  <% else %>
    <div class="bg-blue-900 border border-blue-700 p-8 text-center">
      <p class="text-gray-400">No buildings constructed yet.</p>
      <p class="text-sm text-gray-500 mt-2">
        <%= link_to "Construct your first building", new_building_path, 
            class: "text-orange-400 hover:text-orange-300 underline",
            data: { turbo_frame: "content_panel" } %>
      </p>
    </div>
  <% end %>

  <div class="mt-8 text-sm text-gray-500">
    <p>Keyboard: Tab to focus list, j/k to navigate, Enter to view details</p>
  </div>
</div>
</turbo-frame>
