<turbo-frame id="content_panel">
<%= render 'shared/breadcrumbs' %>

<div class="max-w-6xl">
  <h2 class="text-2xl font-bold mb-4 text-orange-500">Navigation</h2>

  <% if @ship.nil? %>
    <div class="bg-red-900 border border-red-700 rounded p-4 mb-6">
      <p class="text-red-300">
        ‚ö† No operational ship available.
        <%= link_to "Acquire", new_ship_path, class: "text-orange-400 hover:text-orange-300 underline", data: { turbo_frame: "content_panel" } %>
        or
        <%= link_to "repair", ships_path, class: "text-orange-400 hover:text-orange-300 underline", data: { turbo_frame: "content_panel" } %>
        a ship to navigate.
      </p>
    </div>
  <% end %>

  <!-- Current Location -->
  <div class="bg-blue-900 border border-blue-700 rounded p-4 mb-6">
    <h3 class="text-lg font-semibold text-lime-400 mb-2">Current Location</h3>
    <div class="grid grid-cols-2 gap-4 text-sm">
      <div>
        <span class="text-gray-400">System:</span>
        <span class="text-white ml-2"><%= link_to @current_system.name, system_path(@current_system), class: "hover:text-orange-400 underline", data: { turbo_frame: "content_panel" } %></span>
      </div>
      <div>
        <span class="text-gray-400">Coordinates:</span>
        <span class="text-white ml-2">(<%= @current_system.x %>, <%= @current_system.y %>, <%= @current_system.z %>)</span>
      </div>
      <div>
        <span class="text-gray-400">Star Type:</span>
        <span class="text-white ml-2"><%= @current_system.properties&.dig("star_type")&.humanize || "Unknown" %></span>
      </div>
      <div>
        <span class="text-gray-400">Hazard Level:</span>
        <span class="text-white ml-2"><%= @current_system.properties&.dig("hazard_level") || 0 %>%</span>
      </div>
    </div>

    <% if @ship %>
      <div class="mt-4 pt-4 border-t border-blue-700">
        <div class="flex items-center justify-between text-sm">
          <div>
            <span class="text-gray-400">Ship:</span>
            <span class="text-white ml-2"><%= @ship.name %></span>
            <span class="text-gray-500 ml-1">(<%= @ship.hull_size.humanize %>)</span>
          </div>
          <div>
            <span class="text-gray-400">Fuel:</span>
            <span class="<%= @ship.fuel < 10 ? 'text-red-400' : 'text-lime-400' %> ml-2"><%= @ship.fuel.round(1) %></span>
          </div>
          <div>
            <span class="text-gray-400">Status:</span>
            <span class="<%= @ship.status == 'docked' ? 'text-lime-400' : 'text-orange-400' %> ml-2"><%= @ship.status.humanize %></span>
          </div>
        </div>
      </div>
    <% end %>
  </div>

  <% if @ship&.status == 'in_transit' %>
    <!-- In Transit View -->
    <%= render 'navigation/in_transit', ship: @ship %>
  <% else %>
    <% if @requested_destination && @requested_destination != @current_system %>
      <!-- Requested Destination -->
      <div class="bg-orange-900 border-2 border-orange-500 rounded p-4 mb-6">
        <h3 class="text-lg font-semibold text-orange-400 mb-2">üìç Navigate to <%= link_to @requested_destination.name, system_path(@requested_destination), class: "hover:text-orange-300 underline", data: { turbo_frame: "content_panel" } %></h3>
        <% warp_dest = @warp_destinations.find { |d| d[:system].id == @requested_destination.id } %>
        <% nearby_dest = @nearby_systems.find { |d| d[:system].id == @requested_destination.id } %>
        <% if warp_dest %>
          <div class="flex items-center justify-between">
            <div>
              <span class="text-purple-400">‚ö° Warp gate available</span>
              <span class="text-gray-400 text-sm ml-2">(<%= warp_dest[:distance] %> LY, <%= warp_dest[:fuel_cost] %> fuel)</span>
            </div>
            <% if warp_dest[:can_reach] %>
              <%= form_with url: warp_navigation_index_path, method: :post, class: "inline" do |f| %>
                <%= f.hidden_field :destination_id, value: @requested_destination.id %>
                <%= f.hidden_field :intent, value: "trade" %>
                <%= f.submit "Warp Now ‚Üí", class: "px-4 py-2 bg-purple-700 hover:bg-purple-600 text-white rounded cursor-pointer" %>
              <% end %>
            <% else %>
              <span class="px-4 py-2 bg-gray-700 text-gray-500 rounded">Insufficient Fuel</span>
            <% end %>
          </div>
        <% elsif nearby_dest %>
          <div class="flex items-center justify-between">
            <div>
              <span class="text-orange-400">üöÄ Conventional travel</span>
              <span class="text-gray-400 text-sm ml-2">(<%= nearby_dest[:distance] %> LY, <%= nearby_dest[:fuel_cost] %> fuel, <%= nearby_dest[:travel_time] %>)</span>
            </div>
            <% if nearby_dest[:can_reach] %>
              <%= form_with url: warp_navigation_index_path, method: :post, class: "inline" do |f| %>
                <%= f.hidden_field :destination_id, value: @requested_destination.id %>
                <%= f.hidden_field :intent, value: "trade" %>
                <%= f.submit "Travel Now ‚Üí", class: "px-4 py-2 bg-orange-700 hover:bg-orange-600 text-white rounded cursor-pointer" %>
              <% end %>
            <% else %>
              <span class="px-4 py-2 bg-gray-700 text-gray-500 rounded">Out of Range</span>
            <% end %>
          </div>
        <% else %>
          <p class="text-gray-400">This system is not currently reachable from your location.</p>
        <% end %>
      </div>
    <% elsif @requested_destination && @requested_destination == @current_system %>
      <div class="bg-lime-900 border border-lime-600 rounded p-4 mb-6">
        <p class="text-lime-400">‚úì You are already at <%= link_to @current_system.name, system_path(@current_system), class: "hover:text-lime-300 underline", data: { turbo_frame: "content_panel" } %></p>
      </div>
    <% end %>
    <!-- Warp Gates (Instant Travel) -->
    <% if @warp_destinations.any? %>
      <div class="bg-blue-900 border border-purple-600 rounded p-4 mb-6">
        <h3 class="text-lg font-semibold text-purple-400 mb-2">‚ö° Warp Gates</h3>
        <p class="text-gray-400 text-xs mb-3">Instant travel via warp network. Fixed fuel cost: <%= WarpGate::WARP_FUEL_COST %></p>
        <div class="space-y-2">
          <% @warp_destinations.each do |dest| %>
            <div class="flex items-center justify-between p-2 bg-blue-800 rounded">
              <div>
                <%= link_to dest[:system].name, system_path(dest[:system]), class: "text-white hover:text-orange-400 underline", data: { turbo_frame: "content_panel" } %>
                <span class="text-gray-500 text-sm ml-2">(<%= dest[:distance] %> LY)</span>
              </div>
              <div class="flex items-center gap-4">
                <div class="text-sm">
                  <span class="text-gray-400">Fuel:</span>
                  <span class="<%= dest[:can_reach] ? 'text-purple-400' : 'text-red-400' %> ml-1"><%= dest[:fuel_cost] %></span>
                </div>
                <% if dest[:can_reach] %>
                  <%= form_with url: warp_navigation_index_path, method: :post, class: "inline" do |f| %>
                    <%= f.hidden_field :destination_id, value: dest[:system].id %>
                    <%= f.hidden_field :intent, value: "trade" %>
                    <%= f.submit "Warp ‚Üí", class: "px-3 py-1 bg-purple-700 hover:bg-purple-600 text-white text-sm rounded cursor-pointer" %>
                  <% end %>
                <% else %>
                  <span class="px-3 py-1 bg-gray-700 text-gray-500 text-sm rounded">Low Fuel</span>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>

    <!-- Nearby Systems (Conventional Travel) -->
    <div class="bg-blue-900 border border-blue-700 rounded p-4 mb-6">
      <h3 class="text-lg font-semibold text-lime-400 mb-2">üöÄ Reachable Systems</h3>
      <% if @nearby_systems.any? %>
        <p class="text-gray-400 text-xs mb-3">Conventional travel. Fuel cost varies by distance.</p>
        <div class="space-y-2">
          <% @nearby_systems.each do |dest| %>
            <div class="flex items-center justify-between p-2 hover:bg-blue-800 rounded <%= dest[:can_reach] ? '' : 'opacity-50' %>">
              <div>
                <%= link_to dest[:system].name, system_path(dest[:system]), class: "text-white hover:text-orange-400 underline", data: { turbo_frame: "content_panel" } %>
                <span class="text-gray-500 text-sm ml-2">(<%= dest[:distance] %> LY)</span>
              </div>
              <div class="flex items-center gap-4">
                <div class="text-sm">
                  <span class="text-gray-400">Fuel:</span>
                  <span class="<%= dest[:can_reach] ? 'text-orange-400' : 'text-red-400' %> ml-1"><%= dest[:fuel_cost] %></span>
                </div>
                <div class="text-sm">
                  <span class="text-gray-400">ETA:</span>
                  <span class="text-gray-300 ml-1"><%= dest[:travel_time] %></span>
                </div>
                <% if dest[:can_reach] %>
                  <%= form_with url: warp_navigation_index_path, method: :post, class: "inline" do |f| %>
                    <%= f.hidden_field :destination_id, value: dest[:system].id %>
                    <%= f.hidden_field :intent, value: "trade" %>
                    <%= f.submit "Travel ‚Üí", class: "px-3 py-1 bg-orange-700 hover:bg-orange-600 text-white text-sm rounded cursor-pointer" %>
                  <% end %>
                <% else %>
                  <span class="px-3 py-1 bg-gray-700 text-gray-500 text-sm rounded">Out of Range</span>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      <% else %>
        <p class="text-gray-500">No known systems within sensor range. Explore to discover new systems.</p>
      <% end %>
    </div>
  <% end %>

  <%# Legacy in-transit section - kept for backwards compatibility %>
  <% if false && @ship&.status == 'in_transit' %>
    <div class="bg-yellow-900 border border-yellow-700 rounded p-4 mb-6">
      <h3 class="text-lg font-semibold text-yellow-400 mb-2">üõ∏ In Transit</h3>
      <p class="text-gray-300">
        En route to <strong class="text-white"><% if @ship.destination_system %><%= link_to @ship.destination_system.name, system_path(@ship.destination_system), class: "hover:text-orange-400 underline", data: { turbo_frame: "content_panel" } %><% else %>Unknown<% end %></strong>
      </p>
      <% if @ship.arrival_at %>
        <p class="text-sm text-gray-400 mt-2">
          ETA: <%= distance_of_time_in_words(Time.current, @ship.arrival_at) %>
        </p>
      <% end %>
    </div>
  <% end %>

  <!-- Explore Button -->
  <div class="mt-6">
    <%= link_to exploration_path, class: "inline-flex items-center gap-2 px-4 py-2 bg-purple-700 hover:bg-purple-600 text-white rounded", data: { turbo_frame: "content_panel" } do %>
      üî≠ Explore
    <% end %>
  </div>

  <div class="mt-6 text-sm text-gray-500">
    <p>
      <span class="text-purple-400">‚ö° Warp</span> = instant via gate ‚Ä¢
      <span class="text-orange-400">üöÄ Travel</span> = conventional flight
    </p>
  </div>
</div>
</turbo-frame>
